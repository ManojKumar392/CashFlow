<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Transactions</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
</head>
<style>
  body { background: linear-gradient(135deg, #e0f7fa, #e1bee7); min-height: 100vh; }
  th.sortable { cursor: pointer; position: relative; user-select: none; }
  th.sortable .arrow { margin-left: 5px; font-size: 0.8rem; opacity: 0.7; }
  th.sortable.asc .arrow::after { content: "‚ñ≤"; }
  th.sortable.desc .arrow::after { content: "‚ñº"; }
  #filterWarning { display: none; }
</style>
<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="#">üíµ CashFlow Dashboard</a>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link active" href="/transactions/view">Transactions</a></li>
        <li class="nav-item"><a class="nav-link" href="/reports">Reports</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Settings</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fw-bold">üìä Transactions</h2>
        <button id="showAddRow" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Add Transaction
        </button>
    </div>

    <!-- Date Range Filter -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <form id="filterForm" class="row g-3 align-items-center">
                <div class="col-auto">
                    <label for="startDate" class="col-form-label fw-bold">From:</label>
                </div>
                <div class="col-auto">
                    <input type="date" class="form-control" id="startDate">
                </div>
                <div class="col-auto">
                    <label for="endDate" class="col-form-label fw-bold">To:</label>
                </div>
                <div class="col-auto">
                    <input type="date" class="form-control" id="endDate">
                </div>
                <div class="col-auto">
                    <button type="button" class="btn btn-outline-primary" id="applyFilter">
                        <i class="bi bi-filter"></i> Apply
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="clearFilter">
                        <i class="bi bi-x-circle"></i> Clear
                    </button>
                </div>
                <!-- Preset Filters -->
                <div class="col-auto">
                    <select id="presetFilter" class="form-select">
                        <option value="">üìÖ Presets</option>
                        <option value="thisMonth">This Month</option>
                        <option value="lastMonth">Last Month</option>
                        <option value="thisYear">This Year</option>
                        <option value="allTime">All Time</option>
                    </select>
                </div>
            </form>
            <div id="filterWarning" class="text-danger mt-2 small fw-bold">
                ‚ö†Ô∏è Start date cannot be later than End date.
            </div>
        </div>
    </div>

<!-- Stats Panel -->
<div id="statsPanel" class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-success mb-2">
            <div class="card-body">
                <h5>Total Income</h5>
                <p id="totalIncome">‚Çπ0</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-danger mb-2">
            <div class="card-body">
                <h5>Total Expense</h5>
                <p id="totalExpense">‚Çπ0</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-primary mb-2">
            <div class="card-body">
                <h5>Net Balance</h5>
                <p id="netBalance">‚Çπ0</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-secondary mb-2">
            <div class="card-body">
                <h5>Difference from Last Month</h5>
                <p id="diffLastMonth">‚Çπ0</p>
            </div>
        </div>
    </div>
</div>

    <!-- Transaction Table -->
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table id="transactionTable" class="table align-middle table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th class="sortable">ID <span class="arrow"></span></th>
                            <th class="sortable">Amount <span class="arrow"></span></th>
                            <th class="sortable">Type <span class="arrow"></span></th>
                            <th class="sortable">Category <span class="arrow"></span></th>
                            <th class="sortable">Description <span class="arrow"></span></th>
                            <th class="sortable">Date <span class="arrow"></span></th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Inline Add Row -->
                        <tr id="addRow" style="display:none;" class="table-success">
                            <td>New</td>
                            <td><input class="form-control" name="amount" type="number" /></td>
                            <td>
                                <select class="form-select" name="type">
                                    <option value="INCOME">INCOME</option>
                                    <option value="EXPENSE">EXPENSE</option>
                                </select>
                            </td>
                            <td><input class="form-control" name="category" type="text" /></td>
                            <td><input class="form-control" name="description" type="text" /></td>
                            <td><input class="form-control" name="date" type="date" /></td>
                            <td class="text-center">
                                <button class="btn btn-success btn-sm" id="saveNew"><i class="bi bi-check-circle"></i></button>
                                <button class="btn btn-secondary btn-sm" id="cancelNew"><i class="bi bi-x-circle"></i></button>
                            </td>
                        </tr>

                        <!-- Existing Transactions -->
                        <tr th:each="transaction : ${transactions}" th:attr="data-id=${transaction.id}">
                            <td th:text="${transaction.id}"></td>
                            <td>
                                <span class="view fw-bold text-primary" th:text="'‚Çπ' + ${transaction.amount}"></span>
                                <input class="edit form-control" name="amount" type="number" th:value="${transaction.amount}" style="display:none;" />
                            </td>
                            <td>
                                <span class="view">
                                    <span th:classappend="${transaction.type == 'INCOME'} ? 'badge bg-success' : 'badge bg-danger'" th:text="${transaction.type}"></span>
                                </span>
                                <select class="edit form-select" name="type" style="display:none;">
                                    <option value="INCOME" th:selected="${transaction.type == 'INCOME'}">INCOME</option>
                                    <option value="EXPENSE" th:selected="${transaction.type == 'EXPENSE'}">EXPENSE</option>
                                </select>
                            </td>
                            <td>
                                <span class="view" th:text="${transaction.category}"></span>
                                <input class="edit form-control" name="category" type="text" th:value="${transaction.category}" style="display:none;" />
                            </td>
                            <td>
                                <span class="view" th:text="${transaction.description}"></span>
                                <input class="edit form-control" name="description" type="text" th:value="${transaction.description}" style="display:none;" />
                            </td>
                            <td>
                                <span class="view text-muted" th:text="${transaction.date}"></span>
                                <input class="edit form-control" name="date" type="date" th:value="${transaction.date}" style="display:none;" />
                            </td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-warning edit-btn"><i class="bi bi-pencil-square"></i></button>
                                <button class="btn btn-sm btn-success save-btn" style="display:none;"><i class="bi bi-save"></i></button>
                                <button class="btn btn-danger btn-sm delete-btn"><i class="bi bi-trash"></i></button>
                                <button class="btn btn-secondary btn-sm cancel-btn" style="display:none;"><i class="bi bi-arrow-counterclockwise"></i></button>
                                <div class="error-message text-danger small mt-1"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ===================== DATE FILTER =====================
function filterTransactions() {
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;
    const warning = document.getElementById("filterWarning");
    const rows = document.querySelectorAll("#transactionTable tbody tr[data-id]");

    if (startDate && endDate && startDate > endDate) {
        warning.style.display = "block";
        return;
    } else {
        warning.style.display = "none";
    }

    rows.forEach(row => {
        const rowDate = row.querySelector("td:nth-child(6) .view").innerText.trim();
        let show = true;
        if (startDate && rowDate < startDate) show = false;
        if (endDate && rowDate > endDate) show = false;
        row.style.display = show ? "" : "none";
    });

    calculateStats();
}

// ===================== DATE PRESET FILTERS =====================
document.getElementById("presetFilter").addEventListener("change", () => {
    const preset = document.getElementById("presetFilter").value;
    const startInput = document.getElementById("startDate");
    const endInput = document.getElementById("endDate");
    const today = new Date();
    let start, end;

    if (preset === "thisMonth") {
        start = new Date(today.getFullYear(), today.getMonth(), 1);
        end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    } else if (preset === "lastMonth") {
        start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
        end = new Date(today.getFullYear(), today.getMonth(), 0);
    } else if (preset === "thisYear") {
        start = new Date(today.getFullYear(), 0, 1);
        end = new Date(today.getFullYear(), 11, 31);
    } else if (preset === "allTime") {
        start = "";
        end = "";
    }

    startInput.value = start ? start.toISOString().split("T")[0] : "";
    endInput.value = end ? end.toISOString().split("T")[0] : "";
    filterTransactions(); // apply filter automatically
});

document.getElementById("applyFilter").addEventListener("click", filterTransactions);
document.getElementById("clearFilter").addEventListener("click", () => {
    document.getElementById("startDate").value = "";
    document.getElementById("endDate").value = "";
    document.getElementById("presetFilter").value = "";
    filterTransactions();
});
// ===================== STATISTICS =====================================
function calculateStats() {
    const rows = document.querySelectorAll("#transactionTable tbody tr[data-id]");
    let totalIncome = 0, totalExpense = 0;
    let lastMonthIncome = 0, lastMonthExpense = 0;

    const today = new Date();
    const lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
    const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);

    rows.forEach(row => {
        if (row.style.display === "none") return; // skip hidden rows

        const type = row.querySelector("[name='type']") ? row.querySelector("[name='type']").value : 
                     row.querySelector(".view span").innerText;
        const amount = parseFloat(row.querySelector("[name='amount']") ? row.querySelector("[name='amount']").value : 
                                  row.querySelector(".view").innerText.replace(/[‚Çπ,]/g, ''));
        const dateStr = row.querySelector("[name='date']") ? row.querySelector("[name='date']").value : 
                        row.querySelector(".view.text-muted").innerText;
        const rowDate = new Date(dateStr);

        if (type === "INCOME") totalIncome += amount;
        else if (type === "EXPENSE") totalExpense += amount;

        if (rowDate >= lastMonthStart && rowDate <= lastMonthEnd) {
            if (type === "INCOME") lastMonthIncome += amount;
            else if (type === "EXPENSE") lastMonthExpense += amount;
        }
    });

    const netBalance = totalIncome - totalExpense;
    const diffLastMonth = (totalIncome - totalExpense) - (lastMonthIncome - lastMonthExpense);

    document.getElementById("totalIncome").innerText = `‚Çπ${totalIncome.toFixed(2)}`;
    document.getElementById("totalExpense").innerText = `‚Çπ${totalExpense.toFixed(2)}`;
    document.getElementById("netBalance").innerText = `‚Çπ${netBalance.toFixed(2)}`;
    document.getElementById("diffLastMonth").innerText = `‚Çπ${diffLastMonth.toFixed(2)}`;
}

// ===================== INLINE ADD / EDIT / DELETE =====================
function attachRowEvents(row) {
    const editBtn = row.querySelector(".edit-btn");
    const saveBtn = row.querySelector(".save-btn");
    const cancelBtn = row.querySelector(".cancel-btn");
    const deleteBtn = row.querySelector(".delete-btn");
    calculateStats();

    if (editBtn) {
        editBtn.addEventListener("click", () => {
            row.querySelectorAll(".view").forEach(el => el.style.display = "none");
            row.querySelectorAll(".edit").forEach(el => el.style.display = "");
            saveBtn.style.display = "";
            cancelBtn.style.display = "";
            editBtn.style.display = "none";
        });
    }

    if (cancelBtn) {
        cancelBtn.addEventListener("click", () => {
            row.querySelectorAll(".view").forEach(el => el.style.display = "");
            row.querySelectorAll(".edit").forEach(el => el.style.display = "none");
            editBtn.style.display = "";
            saveBtn.style.display = "none";
            cancelBtn.style.display = "none";
        });
    }

    if (saveBtn) {
        saveBtn.addEventListener("click", async () => {
            const id = row.getAttribute("data-id");
            const data = {
                amount: row.querySelector("[name='amount']").value.trim(),
                type: row.querySelector("[name='type']").value.trim(),
                category: row.querySelector("[name='category']").value.trim(),
                description: row.querySelector("[name='description']").value.trim(),
                date: row.querySelector("[name='date']").value.trim()
            };
            try {
                const response = await fetch(`/transactions/api/update/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    const cells = row.querySelectorAll("td");
                    cells[1].querySelector(".view").innerText = "‚Çπ" + data.amount;
                    cells[2].querySelector(".view span").innerText = data.type;
                    cells[2].querySelector(".view span").className = data.type === "INCOME" ? "badge bg-success" : "badge bg-danger";
                    cells[3].querySelector(".view").innerText = data.category;
                    cells[4].querySelector(".view").innerText = data.description;
                    cells[5].querySelector(".view").innerText = data.date;
                    cancelBtn.click();
                }
            } catch (err) {
                row.querySelector(".error-message").innerText = "‚ö†Ô∏è Error: " + err.message;
            }
        });
    }

    if (deleteBtn) {
        deleteBtn.addEventListener("click", async () => {
            if (!confirm("Are you sure you want to delete this transaction?")) return;
            const id = row.getAttribute("data-id");
            try {
                const response = await fetch(`/transactions/api/delete/${id}`, { method: "DELETE" });
                if (response.ok) row.remove();
            } catch (err) {
                alert("‚ö†Ô∏è Error: " + err.message);
            }
        });
    }
}

document.getElementById("showAddRow").addEventListener("click", () => {
    document.getElementById("addRow").style.display = "";
});
document.getElementById("cancelNew").addEventListener("click", (e) => {
    e.preventDefault();
    document.getElementById("addRow").style.display = "none";
    document.querySelectorAll("#addRow input, #addRow select").forEach(el => el.value = "");
});
document.getElementById("saveNew").addEventListener("click", async (e) => {
    e.preventDefault();
    const row = document.getElementById("addRow");
    const data = {
        amount: row.querySelector("[name='amount']").value.trim(),
        type: row.querySelector("[name='type']").value.trim(),
        category: row.querySelector("[name='category']").value.trim(),
        description: row.querySelector("[name='description']").value.trim(),
        date: row.querySelector("[name='date']").value.trim()
    };
    try {
        const response = await fetch("/transactions/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    });
        if (response.ok) {
            const saved = await response.json();
            const tbody = document.querySelector("#transactionTable tbody");
            const newRow = document.createElement("tr");
            newRow.setAttribute("data-id", saved.id);
            newRow.innerHTML = `
                <td>${saved.id}</td>
                <td><span class="view fw-bold text-primary">‚Çπ${saved.amount}</span>
                    <input class="edit form-control" name="amount" type="number" value="${saved.amount}" style="display:none;" /></td>
                <td><span class="view"><span class="${saved.type==='INCOME'?'badge bg-success':'badge bg-danger'}">${saved.type}</span></span>
                    <select class="edit form-select" name="type" style="display:none;">
                        <option value="INCOME" ${saved.type==='INCOME'?'selected':''}>INCOME</option>
                        <option value="EXPENSE" ${saved.type==='EXPENSE'?'selected':''}>EXPENSE</option>
                    </select></td>
                <td><span class="view">${saved.category}</span>
                    <input class="edit form-control" name="category" type="text" value="${saved.category}" style="display:none;" /></td>
                <td><span class="view">${saved.description}</span>
                    <input class="edit form-control" name="description" type="text" value="${saved.description}" style="display:none;" /></td>
                <td><span class="view text-muted">${saved.date}</span>
                    <input class="edit form-control" name="date" type="date" value="${saved.date}" style="display:none;" /></td>
                <td class="text-center">
                    <button class="btn btn-sm btn-warning edit-btn"><i class="bi bi-pencil-square"></i></button>
                    <button class="btn btn-sm btn-success save-btn" style="display:none;"><i class="bi bi-save"></i></button>
                    <button class="btn btn-danger btn-sm delete-btn"><i class="bi bi-trash"></i></button>
                    <button class="btn btn-secondary btn-sm cancel-btn" style="display:none;"><i class="bi bi-arrow-counterclockwise"></i></button>
                    <div class="error-message text-danger small mt-1"></div>
                </td>`;
            tbody.appendChild(newRow);
            attachRowEvents(newRow);
            row.style.display = "none";
            row.querySelectorAll("input, select").forEach(el => el.value = "");
        }
    } catch (err) { alert("‚ö†Ô∏è Error: " + err.message); }
});

// Attach events to existing rows
document.querySelectorAll("#transactionTable tbody tr[data-id]").forEach(row => attachRowEvents(row));
</script>
</body>
</html>
